# Here is your stack preview
# You can make advanced changes like modifying your VM,
# installing packages, and running shell commands.

provider:
  aws:
    access_key: '${var.aws_access_key}'
    secret_key: '${var.aws_secret_key}'
resource:
  aws_instance:
    # this is the name of your VM
    reactjs:
      # select your instance_type here: eg. c3.xlarge
      instance_type: t2.medium
      # select your ami (optional) eg. ami-xxxxx (it should be based on ubuntu 14.04)
      ami: ''
      # we will tag the instance here so you can identify it when you login to your AWS console
      tags:
        Name: '${var.koding_user_username}-${var.koding_group_slug}'
      # on user_data section we will write bash and configure our VM
      user_data: |-
        # user_data Script:
        set -e
        export DEBIAN_FRONTEND=noninteractive
        #Adding new source
        #apt-key adv --keyserver pgp.mit.edu --recv-keys 5072E1F5
        DISTRO=$(lsb_release -is | tr '[:upper:]' '[:lower:]')
        CODENAME=$(lsb_release -cs)
        curl -s https://deb.nodesource.com/gpgkey/nodesource.gpg.key | sudo apt-key add -
        #NodeJS version 6.x
        echo "deb https://deb.nodesource.com/node_6.x $CODENAME main" > /etc/apt/sources.list.d/nodesource.list
        echo "deb-src https://deb.nodesource.com/node_6.x $CODENAME main" >> /etc/apt/sources.list.d/nodesource.list
        #Updating packages
        apt-get update -y
        #Installing Packages
        apt-get install -y nodejs
        #Custom Install for npm latest version.
        curl -L https://npmjs.org/install.sh | sudo sh
        #additional packages
        apt-get install -y build-essential
        apt-get install -y git
        #Setting the user var
        export KODING_USER=${var.koding_user_username}
        # grunt-cli is needed by grunt
        npm install -g grunt-cli
        #Creating script to finish the install with the non-root user
        #Cloning the Repository
        echo "git clone https://github.com/facebook/react.git /home/$KODING_USER/react"  > /home/$KODING_USER/react-install.sh
        echo "cd /home/$KODING_USER/react/" >> /home/$KODING_USER/react-install.sh
        echo "npm install" >> /home/$KODING_USER/react-install.sh
        echo "grunt build" >> /home/$KODING_USER/react-install.sh
        #Running final script
        su $KODING_USER -c "sh /home/$KODING_USER/react-install.sh"
        #--
        #---

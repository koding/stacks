# Here is your stack preview
# You can make advanced changes like modifying your VM,
# installing packages, and running shell commands.

provider:
  aws:
    access_key: '${var.aws_access_key}'
    secret_key: '${var.aws_secret_key}'
resource:
  aws_instance:
    # this is the name of your VM
    drupal:
      # select your instance_type here: eg. c3.xlarge
      instance_type: t2.medium
      # select your ami (optional) eg. ami-xxxxx (it should be based on ubuntu 14.04)
      ami: ''
      # we will tag the instance here so you can identify it when you login to your AWS console
      tags:
        Name: '${var.koding_user_username}-${var.koding_group_slug}'
      # on user_data section we will write bash and configure our VM
      user_data: |-
        # user_data Script:
        set -e
        export DEBIAN_FRONTEND=noninteractive
        #Updating packages
        apt-get update -y
        #Installing Packages
        apt-get install -y mysql-server apache2 php5-gd libssh2-php php5 php5-curl php5-mysql
        #Writing the file to create the DB
        echo "CREATE DATABASE drupaldb;" >>drupal.sql
        echo "GRANT ALL PRIVILEGES ON drupaldb.*" >>drupal.sql
        echo "TO drupaluser@localhost" >>drupal.sql
        echo "IDENTIFIED BY 'passwone';" >>drupal.sql
        echo "FLUSH PRIVILEGES;" >>drupal.sql
        #Running script to create the DB
        cat drupal.sql | sudo mysql --defaults-extra-file=/etc/mysql/debian.cnf
        #Modifying the PHP conf file
        sed -i 's/expose_php = On/expose_php = Off/g' /etc/php5/apache2/php.ini
        sed -i 's/allow_url_fopen = On/allow_url_fopen = Off/g' /etc/php5/apache2/php.ini
        a2enmod rewrite
        #Modifying the virtualhost file
        sed -i '/<\/VirtualHost>/d' /etc/apache2/sites-enabled/000-default.conf
        echo "    <Directory /var/www/html>" >> /etc/apache2/sites-enabled/000-default.conf
        echo "        AllowOverride All" >> /etc/apache2/sites-enabled/000-default.conf
        echo "    </Directory>" >> /etc/apache2/sites-enabled/000-default.conf
        echo "</VirtualHost>" >> /etc/apache2/sites-enabled/000-default.conf
        #Restarting the apache & mysql service
        service apache2 restart
        service mysql restart
        #Downloading Drupal 8.1.9
        curl https://ftp.drupal.org/files/projects/drupal-8.1.9.tar.gz -o drupal-8.1.9.tar.gz
        tar -xzf drupal-8.1.9.tar.gz -C /home/$KODING_USER/
        chown -R $KODING_USER:$KODING_USER /home/$KODING_USER/drupal-8.1.9/
        su $KODING_USER -c "cd /home/$KODING_USER/drupal-8.1.9/; rsync -az . /var/www/html"
        su $KODING_USER -c "mkdir /var/www/html/sites/default/files"
        cp -p /var/www/html/sites/default/default.settings.php /var/www/html/sites/default/settings.php
        chmod 664 /var/www/html/sites/default/settings.php
        chown -R www-data:www-data /var/www/html/*
        
        IPVAR=$(curl http://169.254.169.254/latest/meta-data/public-ipv4)
        echo "========================================================"
        echo " Access the configuration console here:"
        echo " http://$IPVAR/"
        echo "========================================================"
        #-----
